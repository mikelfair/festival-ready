<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processing Selection - Festival Ready v3.0</title>
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-F2CSZ9KX52"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-F2CSZ9KX52');
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 60px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .content {
            padding: 40px;
        }
        
        .testimonial-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .testimonial-image {
            width: 100%;
            max-width: 500px;
            height: auto;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            margin-bottom: 20px;
        }
        
        .testimonial-text {
            font-style: italic;
            color: #555;
            line-height: 1.6;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }
        
        .testimonial-author {
            font-weight: 600;
            color: #333;
        }
        
        .processing-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .option-card {
            border: 2px solid #e1e5e9;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        
        .option-card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.2);
        }
        
        .option-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        }
        
        .option-badge {
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .option-price {
            font-size: 2.5rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 10px;
        }
        
        .option-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }
        
        .option-description {
            color: #666;
            line-height: 1.6;
            margin-bottom: 20px;
        }
        
        .option-features {
            list-style: none;
            padding: 0;
            margin-bottom: 20px;
        }
        
        .option-features li {
            color: #666;
            margin-bottom: 8px;
            padding-left: 20px;
            position: relative;
        }
        
        .option-features li::before {
            content: 'âœ“';
            position: absolute;
            left: 0;
            color: #667eea;
            font-weight: bold;
        }
        
        .premium-badge {
            background: #ff6b6b;
        }
        
        .premium-features li::before {
            color: #ff6b6b;
        }
        
        .submit-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 16px 40px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 20px;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.4);
        }
        
        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .processing-options {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .option-card {
                padding: 20px;
            }
            
            .option-price {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸŽ¬ Processing Selection</h1>
            <p id="dynamicHeaderText">We are ready to craft an industry standard film synopsis for your creative project.</p>
        </div>
        
        <div class="content">
            <div class="testimonial-section">
                <img src="images/austin-comedy-awards.png" alt="Austin Comedy Awards" class="testimonial-image">
                <p class="testimonial-text">"I love using Festival Ready. The premium processing blew me away with its insight into my film. It's obvious that Mikel Fair's algorithm is based on real film industry marketing experience. I'm impressed."</p>
                <p class="testimonial-author">- John McManus from Boise, Idaho</p>
            </div>
            
            <div class="processing-options" id="optionsContainer">
                <div class="option-card" data-tier="standard" onclick="selectOption('standard')">
                    <div class="option-badge">STANDARD</div>
                    <div class="option-price">FREE</div>
                    <div class="option-title">Standard Processing</div>
                    <div class="option-description">
                        Professional content generation built on film industry standards and comprehensive historical research. Powered by Google Gemini AI for fast, reliable results.
                    </div>
                    <ul class="option-features">
                        <li>Google Gemini AI technology</li>
                        <li>Film industry-standard formatting</li>
                        <li>Grammar and style optimization</li>
                        <li>Natural, accessible language (9th-grade reading level)</li>
                        <li>FilmFreeway submission-ready format</li>
                        <li>Exclusive 25% discount on film festival submissions</li>
                        <li>Delivered via email in 3-5 minutes</li>
                    </ul>
                </div>
                
                <div class="option-card" data-tier="premium" onclick="selectOption('premium')">
                    <div class="option-badge premium-badge">PREMIUM</div>
                    <div class="option-price">$4.99</div>
                    <div class="option-title">Premium Processing</div>
                    <div class="option-description">
                        Advanced content generation using Mikel Fair's proprietary algorithm. Meticulously crafted to deliver exceptional insight and unparalleled professionalism that exceeds the highest film industry standards.
                    </div>
                    <ul class="option-features premium-features">
                        <li>State-of-the-art AI reasoning technology</li>
                        <li>Film industry-standard formatting</li>
                        <li>Grammar and style optimization</li>
                        <li>Natural, accessible language (9th-grade reading level)</li>
                        <li>FilmFreeway submission-ready format</li>
                        <li>Exclusive 25% discount on film festival submissions</li>
                        <li>Hollywood-caliber marketing language</li>
                        <li>In-depth historical research and film industry analysis</li>
                        <li>Expert-level contextual references</li>
                    </ul>
                </div>
            </div>
            
            <button class="submit-btn" id="submitBtn" onclick="processSubmission()" disabled>
                Select an option to continue
            </button>
            
            <div class="loading" id="loadingContainer">
                <div class="loading-spinner"></div>
                <h3>Processing your submission...</h3>
                <p>This usually takes 2-5 minutes. Please don't close this window.</p>
            </div>
        </div>
    </div>
    
    <!-- Book Banner -->
    <div id="book-banner-container"></div>
    
    <script src="pdf-extraction.js"></script>
    <script src="book-banner.js"></script>
    <script>
        // Initialize book banner
        createBookBanner('book-banner-container', 'processing-selection');
        
        let selectedTier = null;
        let toolData = null;
        let toolType = null;
        
        // Tool type mappings for dynamic header text
        const toolTypeNames = {
            'tagline-generator': 'tagline',
            'film-synopsis': 'film synopsis',
            'screenplay-synopsis': 'screenplay synopsis',
            'music-video-synopsis': 'music video synopsis',
            'actors-biography': 'actor\'s biography',
            'directors-biography': 'director\'s biography',
            'producers-biography': 'producer\'s biography',
            'writers-biography': 'writer\'s biography',
            'actors-statement': 'actor\'s statement',
            'directors-statement': 'director\'s statement',
            'producers-statement': 'producer\'s statement',
            'writers-statement': 'writer\'s statement'
        };
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Get tool type from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            toolType = urlParams.get('tool');
            
            if (!toolType) {
                alert('Error: No tool specified. Redirecting to homepage.');
                window.location.href = 'index.html';
                return;
            }
            
            // Update dynamic header text
            const toolName = toolTypeNames[toolType] || 'content';
            const headerText = `We are ready to craft an industry standard ${toolName} for your creative project.`;
            document.getElementById('dynamicHeaderText').textContent = headerText;
            
            // Load tool data from sessionStorage
            const storageKey = toolType.replace(/-/g, '') + 'Data';
            const storedData = sessionStorage.getItem(storageKey);
            
            if (!storedData) {
                alert('Error: No form data found. Please fill out the form again.');
                window.location.href = toolType + '.html';
                return;
            }
            
            try {
                toolData = JSON.parse(storedData);
            } catch (error) {
                alert('Error: Invalid form data. Please fill out the form again.');
                window.location.href = toolType + '.html';
                return;
            }
            
            // Track page view
            gtag('event', 'page_view', {
                'event_category': 'Processing_Selection',
                'event_label': toolType,
                'value': 1
            });
        });
        
        function selectOption(tier) {
            selectedTier = tier;
            
            // Update UI
            document.querySelectorAll('.option-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            document.querySelector(`[data-tier="${tier}"]`).classList.add('selected');
            
            // Update submit button
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = false;
            
            if (tier === 'standard') {
                submitBtn.textContent = 'Process with Standard AI (FREE)';
            } else {
                submitBtn.textContent = 'Process with Premium AI ($4.99)';
            }
            
            // Track selection
            gtag('event', 'tier_selection', {
                'event_category': 'Processing_Selection',
                'event_label': tier,
                'tool': toolType,
                'value': tier === 'premium' ? 4.99 : 0
            });
        }
        
        async function processSubmission() {
            if (!selectedTier || !toolData) {
                alert('Please select a processing option.');
                return;
            }
            
            // Show loading state
            document.getElementById('optionsContainer').style.display = 'none';
            document.getElementById('submitBtn').style.display = 'none';
            document.getElementById('loadingContainer').style.display = 'block';
            
            try {
                // If premium tier selected, redirect to payment (Stripe)
                if (selectedTier === 'premium') {
                    // For now, we'll process with standard since Stripe isn't set up
                    // In production, this would redirect to Stripe checkout
                    alert('Premium processing coming soon! Processing with standard AI for now.');
                    selectedTier = 'standard';
                }
                
                // Prepare submission data - map form fields to actual database columns in submissions_v3
                const submissionData = {
                    // Personal Information
                    first_name: toolData.first_name,
                    last_name: toolData.last_name,
                    email: toolData.email,
                    person_location: toolData.person_location,
                    
                    // Project Information
                    project_title: toolData.project_title,
                    project_type: toolData.project_type,
                    story_location: toolData.story_location,
                    
                    // Content Fields (map to actual database column names)
                    characters: toolData.main_characters,
                    plot: toolData.main_challenge,
                    script_text: toolData.script_text,
                    uploaded_script_text: toolData.script_upload_text,
                    
                    // Arrays and Lists
                    genres: Array.isArray(toolData.genres) ? toolData.genres : [toolData.genres],
                    
                    // Meta Information
                    country: toolData.country,
                    marketing: toolData.marketing === 'on'
                };
                
                // Submit to Supabase
                const supabaseUrl = 'https://vmfhxkfprrbshwniguaq.supabase.co';
                const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZtZmh4a2ZwcnJic2h3bmlndWFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk2ODYxNTcsImV4cCI6MjA2NTI2MjE1N30.k0OdvFzcO1nwZzxsgLPcQBeSITmV6dA_ncXpN0cpAgQ';
                
                const response = await fetch(`${supabaseUrl}/rest/v1/submissions_v3`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${supabaseKey}`,
                        'apikey': supabaseKey,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify(submissionData)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Supabase API Error:', {
                        status: response.status,
                        statusText: response.statusText,
                        body: errorText,
                        submissionData: submissionData
                    });
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const submission = await response.json();
                const submissionId = submission[0]?.id;
                
                if (!submissionId) {
                    throw new Error('No submission ID returned');
                }
                
                // Trigger processing - NOW INCLUDES TOOLTYPE PARAMETER
                const processResponse = await fetch(`${supabaseUrl}/functions/v1/v3-process-submission`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${supabaseKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        submissionId: submissionId,
                        toolType: toolType,
                        tier: selectedTier
                    })
                });
                
                if (!processResponse.ok) {
                    throw new Error(`Processing failed: ${processResponse.status}`);
                }
                
                // Track successful submission
                gtag('event', 'submission_success', {
                    'event_category': 'Processing',
                    'event_label': toolType,
                    'tier': selectedTier,
                    'value': selectedTier === 'premium' ? 4.99 : 0
                });
                
                // Clear stored data
                const storageKey = toolType.replace(/-/g, '') + 'Data';
                sessionStorage.removeItem(storageKey);
                
                // Redirect to thank you page
                window.location.href = 'thank-you.html?tool=' + toolType + '&tier=' + selectedTier;
                
            } catch (error) {
                console.error('Submission error:', error);
                console.error('Tool data:', toolData);
                console.error('Tool type:', toolType);
                
                // Track error
                gtag('event', 'submission_error', {
                    'event_category': 'Processing',
                    'event_label': toolType,
                    'error': error.message
                });
                
                // Show detailed error for debugging
                alert(`There was an error processing your submission: ${error.message}\n\nPlease check the browser console for more details or contact support.`);
                
                document.getElementById('loadingContainer').style.display = 'none';
                document.getElementById('optionsContainer').style.display = 'grid';
                document.getElementById('submitBtn').style.display = 'block';
            }
        }
        
        function getSubmissionType(toolType) {
            if (toolType.includes('synopsis')) {
                return toolType.replace('-synopsis', '');
            } else if (toolType.includes('biography')) {
                return 'biography';
            } else if (toolType.includes('statement')) {
                return 'statement';
            } else if (toolType === 'tagline-generator') {
                return 'tagline';
            }
            return 'unknown';
        }
    </script>
</body>
</html>