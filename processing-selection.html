<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Choose Your Processing Level - Festival Ready</title>
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-106157234"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-106157234', {
        'cookie_domain': 'filmfestivalcircuit.com',
        'cookie_flags': 'SameSite=None;Secure'
      });
    </script>
    
    <!-- Supabase Client -->
    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.45.4';
        
        const SUPABASE_URL = 'https://vmfhxkfprrbshwniguaq.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZtZmh4a2ZwcnJic2h3bmlndWFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk2ODYxNTcsImV4cCI6MjA2NTI2MjE1N30.k0OdvFzcO1nwZzxsgLPcQBeSITmV6dA_ncXpN0cpAgQ';
        
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        window.supabase = supabase;
    </script>
    
    <!-- Stripe -->
    <script src="https://js.stripe.com/v3/"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: white;
            color: #333;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: #667eea;
        }
        
        .header p {
            font-size: 1.1em;
            color: #666;
        }
        
        .processing-selection {
            background: white;
            border-radius: 10px;
            padding: 40px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        .selection-intro {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .selection-intro h2 {
            color: #333;
            font-size: 1.8em;
            margin-bottom: 10px;
        }
        
        .selection-intro p {
            color: #666;
            font-size: 1.1em;
        }
        
        .processing-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .option {
            border: 3px solid #e0e0e0;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .option:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .option.standard {
            border-color: #28a745;
        }
        
        .option.standard:hover {
            border-color: #20c997;
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.2);
        }
        
        .option.premium {
            border-color: #667eea;
            background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
            position: relative;
        }
        
        .option.premium:hover {
            border-color: #5a67d8;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .option.premium::before {
            content: "‚≠ê POPULAR";
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .option h3 {
            font-size: 1.6em;
            margin-bottom: 15px;
            color: #333;
        }
        
        .price {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .option.standard .price {
            color: #28a745;
        }
        
        .option.premium .price {
            color: #667eea;
        }
        
        .promo {
            background: #fff3cd;
            color: #856404;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin-bottom: 20px;
            display: inline-block;
        }
        
        .option ul {
            list-style: none;
            margin-bottom: 25px;
            text-align: left;
        }
        
        .option li {
            padding: 8px 0;
            position: relative;
            padding-left: 25px;
            color: #555;
        }
        
        .option li::before {
            content: "‚úì";
            position: absolute;
            left: 0;
            color: #28a745;
            font-weight: bold;
        }
        
        .option.premium li::before {
            color: #667eea;
        }
        
        .option button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .option.standard button {
            background: #28a745;
            color: white;
        }
        
        .option.standard button:hover {
            background: #218838;
            transform: translateY(-1px);
        }
        
        .option.premium button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 6px rgba(102, 126, 234, 0.3);
        }
        
        .option.premium button:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
        }
        
        .option button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .processing-info {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-top: 30px;
        }
        
        .processing-info h3 {
            color: #495057;
            margin-bottom: 10px;
        }
        
        .processing-info p {
            color: #6c757d;
            font-size: 0.95em;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #f5c6cb;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #c3e6cb;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .processing-selection {
                padding: 20px;
            }
            
            .processing-options {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .option {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé¨ Choose Your Processing Level</h1>
            <p>Select the AI processing tier that's right for you</p>
        </div>
        
        <div class="processing-selection">
            <div class="selection-intro">
                <h2>Ready to Generate Your Content</h2>
                <p>Choose between our free standard processing or upgrade to premium for enhanced AI analysis</p>
            </div>
            
            <div class="processing-options">
                <div class="option standard">
                    <h3>üìù Standard Processing</h3>
                    <div class="price">FREE</div>
                    <ul>
                        <li>AI-generated content</li>
                        <li>Professional formatting</li>
                        <li>Email delivery</li>
                        <li>Industry-standard quality</li>
                        <li>Fast processing</li>
                    </ul>
                    <button onclick="processStandard()" id="standardButton">
                        Process for Free
                    </button>
                </div>
                
                <div class="option premium">
                    <h3>‚≠ê Premium Processing</h3>
                    <div class="price">$4.99</div>
                    <div class="promo">Use code: festivalready25 for 25% off!</div>
                    <ul>
                        <li>Enhanced AI model (Gemini 2.0 Pro)</li>
                        <li>Industry-specific insights</li>
                        <li>Advanced formatting & structure</li>
                        <li>Extended length output</li>
                        <li>Priority processing</li>
                        <li>Professional polish</li>
                    </ul>
                    <button onclick="processPremium()" id="premiumButton">
                        Upgrade to Premium
                    </button>
                </div>
            </div>
            
            <div class="processing-info">
                <h3>üí° What happens next?</h3>
                <p>After selecting your processing level, our AI will analyze your submission and generate a professional statement. You'll receive your results via email within minutes. Your generated content will be ready to copy and paste directly into film festival submission forms.</p>
            </div>
            
            <div id="messages"></div>
        </div>
    </div>
    
    <script>
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const submissionId = urlParams.get('id');
        const toolType = urlParams.get('tool');
        
        // Initialize Stripe
        const stripe = Stripe('pk_live_51QVIpQLP3rBZGjmqS3w7rTGr5a3dVGV9gGKZGLQT2V2uqQJj8hhWgNhUJT6fGqnwNKJKlqNJEb6nVhQyv4KjrQB100UBbEfQeE'); // You'll need to set this
        
        if (!submissionId || !toolType) {
            showMessage('Invalid submission. Please start over.', 'error');
        }
        
        async function processStandard() {
            const button = document.getElementById('standardButton');
            button.disabled = true;
            button.textContent = 'Processing...';
            
            try {
                // Update submission to standard processing
                const { error: updateError } = await supabase
                    .from(getTableName(toolType))
                    .update({ 
                        processing_tier: 'standard',
                        payment_status: 'not_required'
                    })
                    .eq('id', submissionId);
                
                if (updateError) {
                    throw updateError;
                }
                
                // Track selection
                gtag('event', 'processing_tier_selected', {
                    'event_category': 'Tool_Usage',
                    'event_label': 'standard',
                    'custom_parameter': toolType
                });
                
                // Trigger edge function processing
                const { data, error } = await supabase.functions.invoke(`process-${toolType}`, {
                    body: { submission_id: submissionId }
                });
                
                if (error) {
                    throw error;
                }
                
                showMessage('Your request is being processed! You will receive an email with your generated content within the next few minutes.', 'success');
                
                // Redirect to thank you page after a delay
                setTimeout(() => {
                    window.location.href = `thank-you.html?tool=${toolType}&tier=standard`;
                }, 3000);
                
            } catch (error) {
                console.error('Standard processing error:', error);
                showMessage('An error occurred while processing your request. Please try again.', 'error');
                button.disabled = false;
                button.textContent = 'Process for Free';
            }
        }
        
        async function processPremium() {
            const button = document.getElementById('premiumButton');
            button.disabled = true;
            button.textContent = 'Redirecting to Payment...';
            
            try {
                // Track premium selection
                gtag('event', 'processing_tier_selected', {
                    'event_category': 'Tool_Usage',
                    'event_label': 'premium',
                    'custom_parameter': toolType
                });
                
                // Create Stripe checkout session
                const response = await fetch('/.netlify/functions/create-checkout-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        submission_id: submissionId,
                        tool_type: toolType,
                        price: 4.99
                    })
                });
                
                const session = await response.json();
                
                if (session.error) {
                    throw new Error(session.error);
                }
                
                // Redirect to Stripe Checkout
                const result = await stripe.redirectToCheckout({
                    sessionId: session.sessionId
                });
                
                if (result.error) {
                    throw new Error(result.error.message);
                }
                
            } catch (error) {
                console.error('Premium processing error:', error);
                showMessage('An error occurred while setting up payment. Please try again.', 'error');
                button.disabled = false;
                button.textContent = 'Upgrade to Premium';
            }
        }
        
        function getTableName(toolType) {
            // Convert tool type to table name
            const tableMap = {
                'directors-statement': 'directors_statements',
                'producers-statement': 'producers_statements',
                'actors-statement': 'actors_statements',
                'writers-statement': 'writers_statements',
                'directors-biography': 'directors_biographies',
                'producers-biography': 'producers_biographies',
                'actors-biography': 'actors_biographies',
                'writers-biography': 'writers_biographies',
                'film-synopsis': 'film_synopsis',
                'screenplay-synopsis': 'screenplay_synopsis',
                'music-video-synopsis': 'music_video_synopsis',
                'tagline': 'tagline_generator'
            };
            
            return tableMap[toolType] || 'directors_statements';
        }
        
        function showMessage(message, type) {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = '';
            
            const messageElement = document.createElement('div');
            messageElement.className = type === 'error' ? 'error-message' : 'success-message';
            messageElement.textContent = message;
            messagesDiv.appendChild(messageElement);
            
            // Scroll to message
            messageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        // Track page view
        gtag('event', 'page_view', {
            'event_category': 'Processing_Selection',
            'event_label': toolType || 'unknown'
        });
    </script>
</body>
</html>